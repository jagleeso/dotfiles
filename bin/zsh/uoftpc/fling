#!/usr/bin/env bash
source $(dirname $(realpath $0))/common.sh
set -x
set -e
cd $AOSP/out/target/product/mako/

adb root
crun adb_sudo 'mount -o remount,rw /system'
# .so files modified in last 24 hours
find . -type f -mtime -1 -print0 | xargs -0 stat --format '%Y :%y %n' | sort -nr | cut -d: -f2- | grep '\s\+./system.*\.so' | perl -lane 'print $F[-1]' | \
    while read f; do
    dst=$(perl -lape 's/^\.//'<<<$f)
    echo adb push $f $dst
    adb push $f $dst
done

adb reboot
# crun adb_sudo kill $(RUN_COMMON=yes $EXPR/scripts/sh/common.sh adb_getpid system_server)
# sleep 3
wait_for_boot

crun adb_sudo dumpsys SurfaceFlinger "$@"
